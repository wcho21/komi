#!/usr/bin/env bash
# build: wrapper script to build or clean wasm artifact

# internal variables
BUILD_MODE="--release"
COMMAND="build"
WASM_OUT_NAME="komi"
WASM_OUT_SCOPE="wcho21"

echo "build: started."

fail() {
  echo "build: failed."
  exit 1
}

# script body
build() {
  cd komi_wasm

  # avoid using '--target bundler' due to limited support in modern bundlers
  # for example, 'bun' doesn't support it at all, and 'vite' can include it via 'vite-plugin-wasm' plugin, it doesn't work with 'vitest'
  # see https://rustwasm.github.io/docs/wasm-bindgen/reference/deployment.html#bundlers
  wasm-pack build --target web ${BUILD_MODE} --out-name ${WASM_OUT_NAME} --scope ${WASM_OUT_SCOPE}

  if [ $? -ne 0 ]; then
    fail
  fi

  if [[ "${BUILD_MODE}" == "--dev" ]]; then
    exit 0
  fi
}

clean() {
  rm -rf ${OUT_DIR}
}

help() {
  echo "build: Usage: $0 [clean|help] [--dev|--release]"
}

for ARG in "$@"; do
  case $ARG in
    "clean")
      COMMAND="clean"
      ;;
    "help")
      COMMAND="help"
      ;;
    "--dev")
      BUILD_MODE="--dev"
      ;;
    "--release")
      BUILD_MODE="--release"
      ;;
    *)
      echo "build: unknown option '${ARG}'"
      help
      fail
    ;;
  esac
done

case $COMMAND in
  "build")
    build
    ;;
  "help")
    help
    ;;
  "clean")
    clean
    ;;
  *)
    echo "build: unexpected command '${COMMAND}'"
    fail
esac